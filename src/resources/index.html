<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Salmonberry</title>
	</head>

	<style>
		body {
			font-family: monospace;
		}

		.small {
			font-size: .8em;
		}

		.faded {
			opacity: .3;
		}

		.step-1 {

		}

		/* disabling toggle for step1 */
		.step-1-disabler {
		}

		.step-2-disabler {
		}

		.step-2 {
		}

		#drawspace {
			outline: 1px solid rgba(0, 0, 0,.2);
			display: block;
			margin-right: auto;
			margin-left: auto;
			margin-bottom: 7px;
		}

		.controlbutton{
			-webkit-touch-callout: none;
			-webkit-user-select: none; 
			-khtml-user-select: none;
			-moz-user-select: none; 
			-ms-user-select: none; 
			-o-user-select: none;
			user-select: none;

			width: 35px;
			height: 35px;
			border-radius: 5px;
		}
	</style>


	<body>
		<!-- STEP 1 -->
		<div style="max-width: 600px; margin-left: auto; margin-right: auto;">

			<h2 style="margin-bottom: 0px;">Salmonberry</h2>
			<p class="small" style="margin-top: 0px;">
				v0.0.2<span class="faded">&emsp;|&emsp;</span>Pre-alpha<span class="faded">&emsp;|&emsp;</span>May wipe any time
				<br/>Refresh tick rate currently every: <u><code style="color: rgb(250, 125, 10)"><span id="tick-time">????</code></u> ms
			</p>

			<hr class="faded"/>
			<p>
				<input autocomplete="false" hidden></input>
				<strong>Username:</strong> <input class="step-1 step-1-disabler" id="username" autocomplete="off" style="width: 100px" type="input" name="id"></input>
				<button id="username-confirm" class="step-1 step-1-disabler" value="Join" onClick="resolveID();">Join</button>
				<button class="step-2 step-2-disabler" onClick="reset();">Exit</button>
				<br/><span class="small">Once created, your icon will be the first letter of your Username</span>
			</p>

			<!-- STEP 2 -->
			<hr class="faded"/>
			<div class="step-2" style="width: 100%; text-align: center;">
				<canvas id="drawspace" width="290" height="310"></canvas>
				<form style="margin-top: 0px;">
					<input class="controlbutton step-2-disabler" type="button" name="input" value="&#9664;" onClick="sendInput('L');">
					<input class="controlbutton step-2-disabler" type="button" name="input" value="&#9654;" onClick="sendInput('R');">
					&nbsp;
					<input class="controlbutton step-2-disabler" type="button" name="input" value="&#9650;" onClick="sendInput('U');">
					<input class="controlbutton step-2-disabler" type="button" name="input" value="&#9660;" onClick="sendInput('D');">
					<p class="small" style="margin-bottom: 0px; margin-top: 0px;">WASD and arrow keys work too once joined</p>
				</form>
			</div>

		</div>
		<!-- Page interactions -->
		<script type="text/javascript">

			// Variables
			let id = null;
			let step = 1;
			const activeTickTime = 250;
			const idleTickTime = 2000;

			// Groups
			let bundle1 = document.getElementsByClassName("step-1"); // Section/Step 1
			let bundle2 = document.getElementsByClassName("step-2"); // Section/Step 2
			let bundle1Disabler = document.getElementsByClassName("step-1-disabler"); // Form elements with disabling for Section/Step 1
			let bundle2Disabler = document.getElementsByClassName("step-2-disabler"); // Form elements with disabling for Section/Step 2

			// Listeners
			window.addEventListener('keydown', (e) => {
				if(step == 2) {
					switch(e.key) {
						case "w":
						case "ArrowUp": sendInput("U"); break;
						
						case "a":
						case "ArrowLeft": sendInput("L"); break;

						case "s":
						case "ArrowDown": sendInput("D"); break;

						case "d":
						case "ArrowRight": sendInput("R"); break;
					}
				}
			});

			function setEnabled(target, isEnabled) {
				for (i = 0; i < target.length; i++) {
					if(isEnabled) {
						target[i].disabled = false;
					} else {
						target[i].disabled = true;
					}
				}
			}

			function setVisibility(bundle, isVisible) {
				for (i = 0; i < bundle.length; i++) {
					if(isVisible) {
						bundle[i].style.display = "inline";
					} else {
						bundle[i].style.display = "none";
					}
				}
			}

			function resolveID() {
				let username = document.getElementById("username").value;

				if(username.length >= 1)
				{
					sendEventCreate(username, ()=>{
						id = username;
						step++;
						setVisibility(bundle2, true);
						setEnabled(bundle1Disabler, false);
						setEnabled(bundle2Disabler, true);
						sendEventState();
					});
				}
			}

			function reset() {
				window.location.href = window.location.href.split('?')[0];
			}


			  //////////////////////////////////
			 // Requests to send and whatnot //
			//////////////////////////////////

			function func() {
				console.log(this.responseText)
			}

			function sendEventState() {
				sendRequest("state",
					function() {
						drawState(this.responseText);
					}),
					(err) => {
						console.log("Error retrieving state!"); 
					};
			}

			function sendEventCreate(targetID, onSuccess) {
				sendRequest("create?id=" + targetID,
					() => { 
						onSuccess();
						console.log("Successfully created ID: " + targetID);
					},
					(err) => {
						console.log("Error sending create request!"); 
					});
			}

			function sendInput(input) {
				sendRequest("input?id=" + id + "&input=" + input,
					function() { 
					    console.log("Successfully sent input '" + input + "' for ID: " + id);
						sendEventState();
				    },
					(err) => {
						console.log("Error sending create request!"); 
					});
			}


			  ////////////////////////////////////////////////
			 // Helper functions, some from around the web //
			////////////////////////////////////////////////

			// takes the JSON state response and draws it out
			function drawState(rawResponse) {
				let c = document.getElementById("drawspace");
				let ctx = c.getContext("2d");
				let state = JSON.parse(rawResponse);

				ctx.clearRect(0, 0, c.width, c.height);
				ctx.font = "12px Courier";

				// Split manually because fillText doesn't handle multiple lines.
				let toDraw = state.data.split('\n');
				const offset = 12; // line height
				for(let i = 0; i < toDraw.length; ++i) {
					ctx.fillText(toDraw[i], 0, offset * (i + 1));
				}
			}

			// endpoint is the location on the server to hit:
			function sendRequest(endpoint, onLoad, onError)
			{
				let url = "http://{{TARGET_ADDR}}/" + endpoint;
				console.log("Sending to " + url);
				let httpReq = new XMLHttpRequest();

				httpReq.onload = onLoad;
				httpReq.onerror = onError;
				httpReq.open('POST', url, true);
				httpReq.setRequestHeader('Content-type', 'application/json');
				httpReq.send();
			}


			// From https://davidwalsh.name/query-string-javascript
			function getUrlParameter(name) {
				name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
				var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
				var results = regex.exec(location.search);
				return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
			};

			// From https://stackoverflow.com/a/26257722/5383198
			function removeURLParameter(url, parameter) {
				let urlparts= url.split('?');   

				if (urlparts.length >= 2) {
					let prefix = encodeURIComponent(parameter)+'=';
					let pars = urlparts[1].split(/[&;]/g);

					for (let i = pars.length; i-- > 0;) {
						if (pars[i].lastIndexOf(prefix, 0) !== -1) {  
							pars.splice(i, 1);
						}
					}

					url = urlparts[0] + '?' + pars.join('&');
				}

				return url;
			}


			  ///////////////////////////////////
			 // Any recurring / initial setup //
			///////////////////////////////////
			
			// Disable step 2 by default
			setEnabled(bundle2Disabler, false);

			// Get the input field
			let input = document.getElementById("username");

			// Execute a function when the user releases a key on the keyboard
			input.addEventListener("keyup", function(event) {
			  if (event.keyCode === 13) { // That's enter
			    event.preventDefault();
			    document.getElementById("username-confirm").click();
			  }
			});

			// Start up at idle tick rate
			sendEventState();
			document.getElementById('tick-time').innerHTML = idleTickTime;
			setInterval(function() { 
					if(step == 1) {
						document.getElementById('tick-time').innerHTML = idleTickTime;
						sendEventState()
					}
				}, idleTickTime);

			// Prepare for active tick rate
			setInterval(function() { 
					if(step == 2) {
						document.getElementById('tick-time').innerHTML = activeTickTime;
						sendEventState()
					}
				}, activeTickTime);
		</script>
	</body>
</html>